steps:
- task: ShellScript@2
  displayName: "Run Tests (stop on error)"
  continueOnError: "false"
  inputs:
    scriptPath: "scripts/funcTests/runFuncTests2.sh"
    args: '6.0.3xx'
    disableAutoCwd: "true"
    cwd: "$(Build.Repository.LocalPath)"
  condition: "and(succeeded(), not(eq(variables['IsOfficialBuild'], 'true')))"

- script: |
    cd $BUILD_REPOSITORY_LOCALPATH
    export VSTEST_BUILD_TRACE=1
    echo "VSTEST_BUILD_TRACE : $VSTEST_BUILD_TRACE"
    echo "./cli/dotnet test ./test/NuGet.Core.Tests/NuGet.Common.Test/bin/release/netcoreapp3.1/NuGet.Common.Test.dll --blame-crash --blame-crash-dump-type diag"
    ./cli/dotnet test ./test/NuGet.Core.Tests/NuGet.Common.Test/bin/release/netcoreapp3.1/NuGet.Common.Test.dll --verbosity  detailed --blame-crash --blame-crash-collect-always --diag:$BUILD_REPOSITORY_LOCALPATH/log/log2.txt
    echo "single test exitcode is $?"

    cd ~/Library/Logs/DiagnosticReports
    pwd
    echo "==== ls ====="
    ls -l
    cd $BUILD_REPOSITORY_LOCALPATH
    mkdir log
    cp ~/Library/Logs/DiagnosticReports/*  ./log/*
    echo "==== ls -l $BUILD_REPOSITORY_LOCALPATH/log ====="
    ls -l $BUILD_REPOSITORY_LOCALPATH/log

- task: PublishBuildArtifacts@1
  displayName: "Publish log"
  inputs:
    PathtoPublish: "$(Build.Repository.LocalPath)/log"
    ArtifactName: "$(Agent.JobName)"
    ArtifactType: "Container"
  condition: "succeededOrFailed()"

- task: PublishTestResults@2
  displayName: "Publish Test Results"
  inputs:
    testRunner: "VSTest"
    testResultsFiles: "*.trx"
    searchFolder: "$(Build.Repository.LocalPath)/build/TestResults"
    mergeTestResults: "true"
    testRunTitle: "NuGet.Client Tests On Mac"
  condition: "succeededOrFailed()"
